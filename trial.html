<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Visualization Insights</title>

	<!-- Bootstrap Core CSS -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom CSS -->
	<link href="css/custom.css" rel="stylesheet">

	<!-- Custom Fonts -->
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

	<!-- Custom JavaScript -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="js/timeme.js"></script>

	<!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
	<script type="text/javascript">
		var urlParams = new URLSearchParams(window.location.search);

		var prolific_PID = urlParams.get('PROLIFIC_PID');
		var session_ID = urlParams.get('SESSION_ID');
		var mod = urlParams.get('modulo');
		var conditions = urlParams.get('vis').split(",");
		var incentives = urlParams.get('alpha').split(",");
		var payout = parseFloat(urlParams.get('out'));
		var result = JSON.parse(urlParams.get('result'));

		TimeMe.initialize({
			currentPageName: "trial-1", // current page
			idleTimeoutInSeconds: 120, // stop recording time due to inactivity
		});
	</script>
</head>
<body>
	<div class="row">
		<div class="container-fluid">
			<div class="col-sm-10 col-sm-offset-1">
				<div class="row">
					<div class="col-lg-10 col-lg-offset-1">
						<h3 class="margin-top-md">Visualization Insights study</h3>
						<p>You are supervising the sales of a group of stores across 10 regions. Each region has 200 stores. You want to find out if the stores are making a profit in each region. However, you only have the data for 10 randomly selected stores from the 200 stores in each region. Below, we show the profit for these 10 stores. Click on which of these regions are making a profit. You can click on multiple stores.</p>

						<p><span id="result-prev">Results of previous round: NA</span><br>
						<span id="payoff">Total Payoff: 0</span></p>
					</div>
				</div>
				<div class="row">
					<div class="col=lg=10 col-sm-offset-1">
						<p><span id="trial_count"></span></p>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-2 col-sm-3 col-lg-offset-1">
						<div class = "question-container" id = "opt-1"></div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-2"></div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-3"></div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-4"></div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-5"></div>
					</div>
					<div class="col-lg-2 col-sm-3 col-lg-offset-1">
						<div class = "question-container" id = "opt-6"></div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-7"></div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-8"></div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-9"></div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-10"></div>
					</div>
				</div>
				<div class="row">
					<div class="btn-container">
						<div class="btn" id="submit-btn">Submit</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-10 col-lg-offset-1">
						<h4>Reward structure</h4>
						<p>By clicking on a region, you indicate that you think the region has a profit greater than zero.</p>
						<ul>
							<li>If you <b>click</b> on a region, and that region <b>does have</b> a profit greater than zero, on average, you will receive a bonus of $0.02. This is a <i>True Positive</i>.</li>
							<li>If you <b>click</b> on a region, and that region <b>does not</b> have a profit greater than zero, on average, you will receive a penalty of <span id="fp-val">-$0.38</span>. This is a <i>False Positive</i>.</li>
							<li>If you <b>do not click</b> on a region, and that region <b>does not</b> have a profit greater than zero on average, you will receive a bonus of $0.02. This is a <i>True Negative</i>.</li>
							<li>If you <b>do not click</b> on a region, and that region <b>does have</b> a profit greater than zero, on average, you will receive a penalty of -$0.02. This is a <i>False Negative</i>.</li>
						</ul>
						<p>Thus your goal is to maximise the number of True Positives and True Negatives.</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
	function shuffle(array) {
		var n = array.length, t, i;
		while (n) {
			i = Math.random() * n-- | 0;
			t = array[n];
			array[n] = array[i];
			array[i] = t;
		}
		return array;
	}

	var selected = [];
	var n = 30;
	var b = [...Array(n).keys()].map( i => ++i );
	var trial_order = b.map( i => (i * mod) % (n+1));
	var index = null;
	var trial_idx = null;
	var i_sd = null;
	var img_order = shuffle([...Array(10).keys()].map( i => ++i ));
	// var i_level = Math.floor(Math.random() * levels.length);

	var trial_count_url = 'https://w3drv4o3cl.execute-api.us-east-2.amazonaws.com/prod/interaction_logger?type=trial_count&PROLIFIC_PID=' + prolific_PID + '&SESSION_ID=' + session_ID + '';

	$.get(trial_count_url, function(data, status) {
		trial_idx = data;

		t_idx = trial_idx % n;
		index = Math.floor(trial_idx / n);
		alpha = parseInt(incentives[index])/100;

		$("span#fp-val").text("-$" + Math.round(((1-alpha)/alpha) * 2) / 100);

		if (trial_idx > 0 & result != null) {
			result_str = "<i>Previous trial:</i> True Positive: " + result['tp'] + ", True Negative: " + result['tn'] + ", False Positive: " + result['fp'] + ", False Negative: " + result['fn'];

			payout += Math.round((result['tp'] * 0.02 + result['tn'] * 0.02 + (result['fp'] * Math.round(((1-alpha)/alpha) * 2) / 100) + result['fn'] * 0.02)*100)/100;	

			$("span#result-prev").html(result_str);
		}
		$("span#payoff").html("<i>Total Payout:</i> " + payout);

		url = "https://raw.githubusercontent.com/MUCollective/vis-insight-reliability/stimuli/plots/"+ conditions[index] +"/profits-t"+ trial_order[t_idx] + "-p";

		$("div#opt-1").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[0] + ".png");
		$("div#opt-2").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[1] + ".png");
		$("div#opt-3").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[2] + ".png");
		$("div#opt-4").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[3] + ".png");
		$("div#opt-5").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[4] + ".png");
		$("div#opt-6").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[5] + ".png");
		$("div#opt-7").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[6] + ".png");
		$("div#opt-8").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[7] + ".png");
		$("div#opt-9").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[8] + ".png");
		$("div#opt-10").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[9] + ".png");

	});

	$(function() {
		$('.question-container').hover(function() {
			$(this).css('background', '#3CA8FF');
		}, function() {
			// on mouseout, reset the background colour
			$(this).css('background', '');
		});
	});

	$(".question-container").click(function () {
		$(this).toggleClass("selected");
		var id_str = $(this).children().attr("src").split("-");
		var id = id_str[id_str.length - 1].split(".")[0];

		if (!selected.includes(id)) {
			selected.push(id);
		} else {
			var idx = selected.indexOf(id);
			if (idx !== -1) selected.splice(idx, 1);
		}
	});

	$("div#submit-btn").on('click', submitResponse);

	// send response to DB
	function submitResponse() {
		// uses global value for 'selected'
		// Time spent on page
		var t = Math.round(TimeMe.getTimeOnCurrentPageInSeconds() * 1000) / 1000;
		var submit_response_url = 'https://w3drv4o3cl.execute-api.us-east-2.amazonaws.com/prod/interaction_logger?type=response&PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&responses='+selected.toString()+'&vis='+conditions[index]+'&alpha='+incentives[index]+'&trial='+trial_order[t_idx]+'&t='+t+'';

		$.get(submit_response_url).done(function (data) {
			if (trial_idx >= (conditions.length * n - 1)){
				window.location.href = 'questionnaire.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'';
			} else {
				if (((trial_idx + 1) % n) == 0) {
					window.location.href = 'intro.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&modulo='+mod+'&vis='+conditions+'&alpha='+incentives+'&out='+payout+'';
				} else {
					window.location.href = 'trial.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&modulo='+mod+'&vis='+conditions+'&alpha='+incentives+'&out='+payout+'&result='+JSON.stringify(data)+'';
				}
			}	
		});
	}
</script>
</html>

