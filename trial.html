<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Visualization Insights</title>

	<!-- Bootstrap Core CSS -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom CSS -->
	<link href="css/custom.css" rel="stylesheet">

	<!-- Custom Fonts -->
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

	<!-- Custom JavaScript -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="js/timeme.js"></script>

	<!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
	<script type="text/javascript">
		var urlParams = new URLSearchParams(window.location.search);

		var prolific_PID = urlParams.get('PROLIFIC_PID');
		var session_ID = urlParams.get('SESSION_ID');
		var mod = urlParams.get('modulo');
		var conditions = urlParams.get('vis').split(",");
		var incentives = urlParams.get('alpha').split(",");
		// var payout = parseFloat(urlParams.get('out'));
		// var result = JSON.parse(urlParams.get('result'));

		TimeMe.initialize({
			currentPageName: "trial", // current page
			idleTimeoutInSeconds: 120, // stop recording time due to inactivity
		});
	</script>
</head>
<body>
	<div class="row">
		<div class="container-fluid">
			<div class="col-sm-10 col-sm-offset-1">
				<div class="row">
					<div class="col-lg-10 col-lg-offset-1">
						<h3 class="margin-top-md">Visualization Insights study</h3>
						<p>You are supervising the sales of a group of stores across 10 regions. Each region has 200 stores. You want to find out if the stores are making a profit in each region. However, you only have the data for 20 randomly selected stores from the 200 stores in each region. Below, we show the profit for these 20 stores. Click on the regions you think are making a profit. You can select multiple regions.</p>

						<h4 class="margin-top-md">Previous trial review</h4>
						<p>
							<span id="result-prev"></span><br>
							<span id="payoff-prev"></span><br>
							<span id="payoff">Total Payoff: 0</span>
						</p>
						<h4 class="margin-top-md">Current trial: No. <span id="trial-num">1</span>/90</h4>
					</div>
				</div>
				<div class="row">
					<div class="col=lg=10 col-sm-offset-1">
						<p><span id="trial_count"></span></p>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-2 col-sm-3 col-lg-offset-1">
						<div class = "question-container" id = "opt-1">
							<p class="region-label">Region 1</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-2">
							<p class="region-label">Region 2</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-3">
							<p class="region-label">Region 3</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-4">
							<p class="region-label">Region 4</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-5">
							<p class="region-label">Region 5</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3 col-lg-offset-1">
						<div class = "question-container" id = "opt-6">
							<p class="region-label">Region 6</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-7">
							<p class="region-label">Region 7</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-8">
							<p class="region-label">Region 8</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-9">
							<p class="region-label">Region 9</p>
						</div>
					</div>
					<div class="col-lg-2 col-sm-3">
						<div class = "question-container" id = "opt-10">
							<p class="region-label">Region 10</p>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="btn-container">
						<div class="btn" id="submit-btn">Submit</div><br>
						<div class="btn-inv" id="submit-none-btn">None of the regions are profitable</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-10 col-lg-offset-1">
						<div class="row">
							<div class="col-sm-12">
								<h3>How your job performance is evaluated</h3>
								<p><img id="payoff-img" src="images/payoff_5.png" align="right">Please read the incentive structure carefully as it will change for every block of trial
								<ul>
									<li><i class="material-icons icon-correct">check_circle</i> If you think a region is profitable on average and <b>select</b> it now based on the 20 stores, and that region <b>does have</b> an average profit greater than zero based on all 200 stores, you will receive 20 points. <!-- This is a <i>True Positive</i>.--></li>
									<li><i class="material-icons icon-correct">check_circle</i> If you <b>do not select</b>  a region, and that region <b>does not</b> have a profit greater than zero on average, you will receive 20 points. <!-- This is a <i>True Negative</i>. --></li>
									<li><i class="material-icons icon-incorrect">cancel</i> If you <b>select</b>  a region, and that region <b>does not</b> have a profit greater than zero, on average, you will lose <span class="highlight">380 points.</span><!--  This is a <i>False Positive</i>. --></li>
									<li><i class="material-icons icon-incorrect">cancel</i> If you <b>do not select</b>  a region, and that region <b>does have</b> a profit greater than zero, on average, you will lose 20 points. <!-- This is a <i>False Negative</i>. --></li>
								</ul>
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
	function shuffle(array) {
		var n = array.length, t, i;
		while (n) {
			i = Math.random() * n-- | 0;
			t = array[n];
			array[n] = array[i];
			array[i] = t;
		}
		return array;
	}

	var selected = [];
	var n = 30;
	var b = [...Array(n).keys()].map( i => ++i );
	var trial_order = b.map( i => (i * mod) % (n+1));
	var index = null;
	var trial_idx = null;
	var i_sd = null;
	var img_order = shuffle([...Array(10).keys()].map( i => ++i ));
	// var i_level = Math.floor(Math.random() * levels.length);

	var trial_count_url = 'https://w8vewq61bf.execute-api.us-east-2.amazonaws.com/prod/recordResponses?type=trial_count&PROLIFIC_PID=' + prolific_PID + '&SESSION_ID=' + session_ID + '';

	$.get(trial_count_url, function(data, status) {
		trial_idx = data['count'];
		console.log(trial_idx);
		$("span#trial-num").html(trial_idx + 1);

		total_pay = 0;
		if (trial_idx > 0) {
			total_pay = data['payout'];
		}

		t_idx = trial_idx % n;
		index = Math.floor(trial_idx / n);
		alpha = parseInt(incentives[index])/100;

		prev = data['prev'];
		prev_pay = (prev['tp'] + prev['tn'] + prev['fn']) * 20 + prev['fp'] * Math.round(((1-alpha)/alpha) * 20);

		$("span#fp-val").text("" + Math.round(((1-alpha)/alpha) * 20) + " points");
		// the payoff matrix images/payoff_5.png
		$("img#payoff-img").attr("src", "images/payoff_" + incentives[index] + ".png");

		if (trial_idx > 0 & prev != "NA") {
			// result_str = "<i>Previous trial:</i> &#x2705; True Positive: " + prev['tp'] + ", &#x2705; True Negative: " + prev['tn'] + ", &#10060 False Positive: " + -1*prev['fp'] + ", &#10060 False Negative: " + -1*prev['fn'];
			result_str = "<i>Previous trial:</i><i class='material-icons icon-correct'>check_circle</i> Selected, profitable: " + prev['tp'] + ",  <i class='material-icons icon-correct'>check_circle</i> Didn't select, not profitable: " + prev['tn'] + ", <i class='material-icons icon-incorrect'>cancel</i> Selected, not profitable: " + -1*prev['fp'] + ", <i class='material-icons icon-incorrect'>cancel</i> Didn't select, profitable: " + -1*prev['fn'];

			$("span#result-prev").html(result_str);
			$("span#payoff-prev").html("<i>Payout from previous trial: </i>" + prev_pay);
			$("span#payoff").html("<i>Total Payout:</i> " + total_pay);
		}

		url = "https://raw.githubusercontent.com/MUCollective/vis-insight-reliability/stimuli/plots/"+ conditions[index] +"/profits-t"+ trial_order[t_idx] + "-p";

		$("div#opt-1").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[0] + ".png");
		$("div#opt-2").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[1] + ".png");
		$("div#opt-3").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[2] + ".png");
		$("div#opt-4").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[3] + ".png");
		$("div#opt-5").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[4] + ".png");
		$("div#opt-6").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[5] + ".png");
		$("div#opt-7").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[6] + ".png");
		$("div#opt-8").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[7] + ".png");
		$("div#opt-9").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[8] + ".png");
		$("div#opt-10").append('<img class = "question-graphic">').children().attr("src", url + "0.5-" + img_order[9] + ".png");

	});

	$(function() {
		$('.question-container').hover(function() {
			$(this).css('background', '#3CA8FF');
		}, function() {
			// on mouseout, reset the background colour
			$(this).css('background', '');
		});
	});

	$(".question-container").click(function () {
		$(this).toggleClass("selected");
		var id_str = $(this).children().attr("src").split("-");
		var id = id_str[id_str.length - 1].split(".")[0];

		if (!selected.includes(id)) {
			selected.push(id);
		} else {
			var idx = selected.indexOf(id);
			if (idx !== -1) selected.splice(idx, 1);
		}
	});

	$("div#submit-btn").on('click', submitResponse);
	$("div#submit-none-btn").on('click', submitNoResponse);

	// send response to DB
	function submitResponse() {
		// uses global value for 'selected'
		// Time spent on page
		var t = Math.round(TimeMe.getTimeOnCurrentPageInSeconds() * 1000) / 1000;

		if (selected.length > 0){
			var submit_response_url = 'https://w8vewq61bf.execute-api.us-east-2.amazonaws.com/prod/recordResponses?type=response&PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&responses='+selected.toString()+'&vis='+conditions[index]+'&alpha='+incentives[index]+'&trial='+trial_order[t_idx]+'&t='+t+'&count='+trial_idx+'';

			$.get(submit_response_url).done(function (data) {
				
			});
		} else {
			alert("Please indicate a region as profitable or click on the button marked, 'None of the regions are profitable'")
		}
	}

	function submitNoResponse() {
		var t = Math.round(TimeMe.getTimeOnCurrentPageInSeconds() * 1000) / 1000;

		if (selected.length == 0){
			var submit_response_url = 'https://w8vewq61bf.execute-api.us-east-2.amazonaws.com/prod/recordResponses?type=response&PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&responses=null&vis='+conditions[index]+'&alpha='+incentives[index]+'&trial='+trial_order[t_idx]+'&t='+t+ '&count='+trial_idx+'';

			$.get(submit_response_url).done(function (data) {
				console.log(data['count']);
			});
		} else {
			alert("You have indicated certain regions as profitable. Please click on the submit button")
		}
	}

	function deferredRedirect(curr_trial) {
		if (trial_idx >= (conditions.length * n - 1)){
			var get_uuid_url = 'https://w8vewq61bf.execute-api.us-east-2.amazonaws.com/prod/user_records?user=old&PROLIFIC_PID='+prolific_PID+'&SESSION_ID=' + session_ID + '';

			$.get(get_uuid_url, function(data, status) {
				uuid = data;

				window.location.href = 'https://umich.qualtrics.com/jfe/form/SV_0O0FsjvFas9tzKd?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&uuid='+uuid+'';
			})
		} else {
			if (((trial_idx + 1) % n) == 0) {
				window.location.href = 'intro.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&modulo='+mod+'&vis='+conditions+'&alpha='+incentives+'';
			} else {
				if ((trial_idx % (n - 3)) == 21){ // three attention checks at 21 48 75
					window.location.href = 'attention.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&modulo='+mod+'&vis='+conditions+'&alpha='+incentives+'';
				} else {
					window.location.href = 'trial.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&modulo='+mod+'&vis='+conditions+'&alpha='+incentives+'';
				}
			}
		}
	}

		// if (trial_idx >= (conditions.length * n - 1)){
		// 	var get_uuid_url = 'https://w8vewq61bf.execute-api.us-east-2.amazonaws.com/prod/user_records?user=old&PROLIFIC_PID='+prolific_PID+'&SESSION_ID=' + session_ID + '';

		// 	$.get(get_uuid_url, function(data, status) {
		// 		uuid = data;

		// 		window.location.href = 'https://umich.qualtrics.com/jfe/form/SV_0O0FsjvFas9tzKd?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&uuid='+uuid+'';
		// 	})
		// } else {
		// 	if (((trial_idx + 1) % n) == 0) {
		// 		window.location.href = 'intro.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&modulo='+mod+'&vis='+conditions+'&alpha='+incentives+'';
		// 	} else {
		// 		if ((trial_idx % (n - 3)) == 21){ // three attention checks at 21 48 75
		// 			window.location.href = 'attention.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&modulo='+mod+'&vis='+conditions+'&alpha='+incentives+'';
		// 		} else {
		// 			window.location.href = 'trial.html?PROLIFIC_PID='+prolific_PID+'&SESSION_ID='+session_ID+'&modulo='+mod+'&vis='+conditions+'&alpha='+incentives+'';
		// 		}
		// 	}
		// }
</script>
</html>


